version: '3.8'

services:
  devcontainer:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Mount the workspace
      - ../..:/workspaces:cached

      # Mount docker socket for docker-in-docker
      - /var/run/docker.sock:/var/run/docker.sock

    working_dir: /workspaces/${localWorkspaceFolderBasename}

    # Override default command so container doesn't exit after starting
    command: sleep infinity

    # Environment variables
    environment:
      - NODE_ENV=development
      - DOCKER_BUILDKIT=1

    # Networking
    network_mode: host

    # Security
    security_opt:
      - label:disable

    # Privileged mode for docker-in-docker
    privileged: true

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
